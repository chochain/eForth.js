<html>
  <head>    
  <title>eForth.js 8.0</title>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css'></link>
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js'></script>
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/forth/forth.min.js'></script>
  <link rel='stylesheet' href='editor.css'></link>
  <script type='text/javascript' src='forth_voc.js'></script>
  </head>
  <body>
    <div class='row' style='height:100%'>
      <div class='col' style='z-index:1; width:15%;'>
        <pre class='hdr'>dictionary</pre>
        <pre id='usr' class='dict'></pre>
        <pre id='dc' class='dict'></pre>
      </div>
      <div class='col' style='z-index:0; width:84%; padding:8px'>
        <div id='edt'>
          <textarea id='cm'>\ type command into the input buffer above, or&#013;\ write your code here&#013;\ highlight the code you want to execute&#013;\ Ctrl-C to copy into the input buffer above&#013;\ then hit <return> to execute</textarea>
        </div>
        <div id='txt' class='txt'></div>
        <div class='row'>
          <input id='tib' class='code' value='' />
          <button style='height:36px; width:5%'
  		     onclick='edt.style.display=(edt.style.display=="none") ? "block" : "none"'><b>Edit</b></button>
        </div>
        <div id='ss' class='ss'>[ ]</div>
      </div>
    </div>
    <script src='../eforth.js'></script>
    <script>
    const usr = document.getElementById('usr')
    const dc  = document.getElementById('dc')
    const tib = document.getElementById('tib')
    const txt = document.getElementById('txt')
    const ss  = document.getElementById('ss')
    const cm  = CodeMirror.fromTextArea(document.getElementById('cm'), {
        lineNumbers: true,
        styleActiveLine: true,
        mode: 'forth'
    })
    cm.on('copy', (doc)=>{
        let cmd=doc.getSelection()
        tib.value = cmd.replace(/[\t|\n]/g,' ')
        tib.style.backgroundColor = '#fe0'
        document.activeElement.blur()
        tib.focus()
    })
    tib.onkeydown = (e)=>{
        if (13==e.keyCode) {
            forth_eval(tib.value)
            tib.style.backgroundColor='white'
            tib.value = ''
            txt.scrollTop = txt.scrollHeight
            tib.focus()
        }
    }
    const rz = new ResizeObserver(e=>{            ///< adjust console height
        edt.style.height = cm.innerHeight
        txt.scrollTop    = txt.scrollHeight
    }).observe(document.getElementById('cm'))
 
    function to_txt(t, esc=true) {
        const escape = (s)=>{
            return s.replace(/\n/g,'<br/>').replace(/\s/g, '&nbsp;')
        }
        txt.innerHTML += esc && typeof(t)=='string' ? escape(t) : t
    }
    function clear_txt() { txt.innerHTML=''; to_txt('<h2>eForth.js 8.0</h2>') }
    function show_cmd(cmd) {
        let htm = cmd.replace(/:/g,'<br/>:')                  /// * show on a new line
        if (htm.indexOf('<br/>')==0) htm.replace('<br/>','')  /// * remove blank lines
        to_txt('<pre class="cmd"><em>'+htm+'</em></pre>', false)
    }
    ///
    /// Forth section
    ///
    let vm = new ForthVM(to_txt)               ///< create Forth VM object
    clear_txt()                                /// * init console area
    show_voc(dc)                               /// * Forth word tree in sidebar

    function forth_eval(cmd) {                 ///< evaludate Forth command
        show_cmd(cmd)
        if (cmd=='clear') clear_txt()
        else {
            vm.exec(cmd)                       /// * can handle multi-line input
            ss.innerHTML = '[ '+vm.ss.map(v=>v.toString(vm.base)).join(' ')+' ]'
            usr.innerHTML = colon_words()
        }
    }
    </script>
    <script type='application/forth'>
      cr .( <h3>\ this demo shows embedded Forth</h3> ) cr
      .( <b>\ list dictionary</b> ) cr
      words
    </script>
    <!--script type='application/forth' src='./tests/embed.f'/-->
  </body>
</html>
