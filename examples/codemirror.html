<html>
  <head>    
  <title>eForth.js 8.0</title>
  <style>
    h2    { color: #c44; margin: 0; }
    h3    { color: #fc4; margin: 0; }
    .col  { display:flex; flex-direction:column; font-size:20px; }
    .row  { display:flex; width:100%; }
    .hdr  { width:100%; text-align:center; background-color:#eee; margin:8px; padding:6px; }
    .lst  { width:96%; text-align:right; color:#484; margin:8px; }
    .txt  { display:block; padding:8px; width:100%; overflow-x:scroll; }
    .code { height:36px; width:90%; font-size:24px;  }
    .cmd  { color:#48f; margin: 2px; }
    .CodeMirror { width:100%; border:1px solid #444; resize: vertical; overflow:auto; }
  </style>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css'></link>
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js'></script>
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/forth/forth.min.js'></script>
  </head>
  <body>
    <div class='row'>
      <div class='col' style='padding:8px; width:85%'>
        <div class='row'>
          <button style='width:10%' onclick='edt.style.display="none"'>editor</button>
          <input id='tib' class='code' value=''
             onkeydown='if (13===event.keyCode) forth_eval()'/>
          <button style='width:10%' onclick='clear_txt()'>clear</button>
        </div>
        <div id='edt'>
          <textarea id='cm'>\ type command into the input buffer above, or&#013;\ write your code here&#013;\ highlight the code you want to execute&#013;\ Ctrl-C to copy into the input buffer above&#013;\ then hit <return> to execute</textarea>
        </div>
        <pre id='txt' class='txt'></pre>
      </div>
      <div class='col'>
        <pre class='hdr'>data stack</pre><pre id='ss' class='lst'></pre>
        <pre class='hdr'>dictionary</pre><pre id='dc' class='lst'></pre>
      </div>
    </div>
    <script src='../eforth.js'></script>
    <script>
    const tib = document.getElementById('tib')
    const txt = document.getElementById('txt')
    const edt = document.getElementById('edt')
    const ss  = document.getElementById('ss')
    const dc  = document.getElementById('dc')
    const cm  = CodeMirror.fromTextArea(document.getElementById('cm'), {
        lineNumbers: true,
        styleActiveLine: true,
        mode: 'forth'
    })
    cm.setSize('100%','100%')
    cm.on('copy', (doc)=>{
        let cmd=doc.getSelection()
        tib.value = cmd.replace(/[\t|\n]/g,' ')
        tib.style.backgroundColor = '#fe0'
        document.activeElement.blur()
        tib.focus()
    })
    let rz = new ResizeObserver(e=>{            ///< adjust console height
        txt.style.height = window.innerHeight - txt.offsetTop - 100
    }).observe(edt)
 
    function to_txt(t, esc=true) {
        const escape = (s)=>{
            return s.replace(/\n/g,'<br/>').replace(/\s/g, '&nbsp;')
        }
        txt.innerHTML += esc && typeof(s)=='string' ? escape(t) : t
    }
    function clear_txt() {
        txt.innerHTML=''
        to_txt('<h2>eForth.js 8.0</h2>')
    }
    ///
    /// Forth section
    ///
    let vm = new ForthVM(to_txt)               ///< create Forth VM object
    function forth_eval() {                    ///< evaludate Forth command
        let cmd = tib.value.replace(/:/g,'<br/>:')
        if (cmd.indexOf('<br/>')==0) cmd.replace('<br/>','')
        
        to_txt('<pre class="cmd"><em>'+cmd+'</em></pre>', false)
        if (cmd=='clear') clear_txt()
        else {
            vm.exec(cmd)                      /// * handle multi-line input
            show_data()                       /// * display ss and dict
        }
        tib.style.backgroundColor='white'
        tib.value = ''
        txt.scrollTop = txt.scrollHeight
    }
    function show_data() {
        dc.innerHTML = vm.dict.filter(v=>v.cat=='ud').map(v=>v.name).reverse().join('<br/>')
        ss.innerHTML = vm.ss.map(v=>v.toString(10)).reverse().join('<br/>')
    }
    </script>
    <script type='application/forth'>
      cr .( <h3>\ this demo shows embedded Forth</h3> ) cr
      .( <b>\ list dictionary</b> ) cr
      words
    </script>
    <script type='application/forth' src='./tests/embed.f'/>
  </body>
</html>
