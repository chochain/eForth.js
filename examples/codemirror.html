<html>
  <head>    
  <title>eForth.js 8.0</title>
  <style>
    h2    { color: #c44; margin: 0; }
    h3    { color: #fc4; margin: 0; }
    .col  { display:flex; flex-direction:column; font-size:20px; border:1px solid #ccc }
    .row  { display:flex; width:100%; }
    .hdr  { text-align:center; background-color:#eee; margin:8px; padding:6px }
    .dict { text-align:left; color:#484; margin:4px; font-family:monospace; overflow-wrap:auto; }
    .code { height:36px; width:95%; font-size:24px; margin:0 2px 3px 2px; }
    .cmd  { color:#48f; margin: 2px; }
    .txt  { display:block; padding:8px; width:100%; font-family:monospace; overflow-x:scroll; }
    .ss   { padding:8px; color:#484; background-color:#eee; font-family:monospace; }
    .CodeMirror { width:100%; border:1px solid #444; resize: vertical; overflow:auto; }
    ul.tree li { list-style-type: none; position: relative; }
    ul.tree li ul { display: none; }
    ul.tree li.open > ul { display: block; }
    ul.tree li a { color: black; text-decoration: none; }
    ul.tree li a:before {
        height: 1em; padding:0 .1em; font-size: .8em; display: block;
        position: absolute; left: -1.3em; top: .2em;
    }
    ul.tree li > a:not(:last-child):before { content: '+'; }
    ul.tree li.open > a:not(:last-child):before { content: '-'; }
  </style>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css'></link>
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js'></script>
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/forth/forth.min.js'></script>
  </head>
  <body>
    <div class='row' style='height:100%'>
      <div class='col' style='width:15%'>
        <pre class='hdr'>dictionary</pre><pre id='dc' class='dict'></pre>
      </div>
      <div class='col' style='width:84%; padding:8px'>
        <div id='edt'>
          <textarea id='cm'>\ type command into the input buffer above, or&#013;\ write your code here&#013;\ highlight the code you want to execute&#013;\ Ctrl-C to copy into the input buffer above&#013;\ then hit <return> to execute</textarea>
        </div>
        <div id='txt' class='txt'></div>
        <div class='row'>
          <input id='tib' class='code' value='' />
          <button style='height:36px; width:5%'
  		     onclick='edt.style.display=(edt.style.display=="none") ? "block" : "none"'><b>Edit</b></button>
        </div>
        <div id='ss' class='ss'>[ ]</div>
      </div>
    </div>
    <script src='../eforth.js'></script>
    <script>
    const dc  = document.getElementById('dc')
    const tib = document.getElementById('tib')
    const txt = document.getElementById('txt')
    const ss  = document.getElementById('ss')
    const cm  = CodeMirror.fromTextArea(document.getElementById('cm'), {
        lineNumbers: true,
        styleActiveLine: true,
        mode: 'forth'
    })
    cm.on('copy', (doc)=>{
        let cmd=doc.getSelection()
        tib.value = cmd.replace(/[\t|\n]/g,' ')
        tib.style.backgroundColor = '#fe0'
        document.activeElement.blur()
        tib.focus()
    })
    tib.onkeydown = (e)=>{
        if (13==e.keyCode) {
            forth_eval(tib.value)
            tib.style.backgroundColor='white'
            tib.value = ''
            txt.scrollTop = txt.scrollHeight
            tib.focus()
        }
    }
      
    let rz = new ResizeObserver(e=>{            ///< adjust console height
        edt.style.height = cm.innerHeight
        txt.scrollTop    = txt.scrollHeight
    }).observe(document.getElementById('cm'))
 
    function to_txt(t, esc=true) {
        const escape = (s)=>{
            return s.replace(/\n/g,'<br/>').replace(/\s/g, '&nbsp;')
        }
        txt.innerHTML += esc && typeof(t)=='string' ? escape(t) : t
    }
    function clear_txt() { txt.innerHTML=''; to_txt('<h2>eForth.js 8.0</h2>') }
    function show_cmd(cmd) {
        let htm = cmd.replace(/:/g,'<br/>:')                  /// * show on a new line
        if (htm.indexOf('<br/>')==0) htm.replace('<br/>','')  /// * remove blank lines
        to_txt('<pre class="cmd"><em>'+htm+'</em></pre>', false)
    }
    function show_dict() {
        dc.innerHTML = voc_tree()
        document.querySelectorAll('ul.tree a:not(:last-child)').forEach(ul=>{
            ul.onclick = e=>{
                var pa = e.target.parentElement
                var cl = pa.classList
                if(cl.contains("open")) {
                    cl.remove('open')
                    pa.querySelectorAll(':scope .open').forEach(c=>{
                        c.classList.remove('open')
                    })
                }
                else cl.add('open')
                e.preventDefault()
            }
        })
    }
    function voc_tree() {
        let x = vm.dict.reduce((r,v)=>{
            const c = {                            ///< category desc lookup
                ss: "Stack",  au: "ALU",    eq: "Compare", io: "IO",    li: "Literal",
                br: "Branch", mm: "Memory", cm: "Compile", db: "Debug", os: "OS"
            }[v.cat]
            if (r[c]) r[c].push(v); else r[c] = [ v ]
            return r
        }, {})
        let div = ''
        Object.keys(x).sort().forEach(k=>{
            div += '<ul class="tree"><li><a href="#">' + k + '</a><ul>'
            x[k].forEach(v=>{ div += '<li><a href="#">'+v.name+'</a></li>' })
            div += '</ul></li></ul>'
        })
        return div
    }
    ///
    /// Forth section
    ///
    let vm = new ForthVM(to_txt)               ///< create Forth VM object
    clear_txt()
    show_dict()

    function forth_eval(cmd) {                 ///< evaludate Forth command
        show_cmd(cmd)
        if (cmd=='clear') clear_txt()
        else {
            vm.exec(cmd)                       /// * can handle multi-line input
            ss.innerHTML = '[ '+vm.ss.map(v=>v.toString(vm.base)).join(' ')+' ]'
            show_dict()
        }
    }
    </script>
    <script type='application/forth'>
      cr .( <h3>\ this demo shows embedded Forth</h3> ) cr
      .( <b>\ list dictionary</b> ) cr
      words
    </script>
    <!--script type='application/forth' src='./tests/embed.f'/-->
  </body>
</html>
