<html>
  <head>    
  <title>eForth.js</title>
  <!--link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css'></link>
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.js'></script>
  <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/mode/forth/forth.min.js'></script-->
  <link rel='stylesheet' href='../tests/codemirror.min.css'></link>
  <script type='text/javascript' src='../tests/codemirror.min.js'></script>
  <script type='text/javascript' src='../tests/forth.min.js'></script>
  <link rel='stylesheet' href='editor.css'></link>
  <script type='text/javascript' src='forth_voc.js'></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  </head>
  <body>
    <div class='row' style='height:100%'>
      <div id='dir' class='col' style='display:none; z-index:1; width:15%;'>
        <pre class='hdr'>dictionary</pre>
        <pre id='usr' class='dict'></pre>
        <pre id='dc' class='dict'></pre>
      </div>
      <div class='col' style='z-index:0; width:100%; padding:8px'>
        <div class='title'>
          <span style='float:left' onclick='toggle("dir")'><i class='material-icons'>menu_open</i></span>
          <span style='float:left' class='logo'>
            <b>eForth 8.0</b> - <em>Forth in Javascript - </em><span id='fname'></span>
          </span>
          <span style='float:right' onclick='toggle("gra")'><i class='material-icons'>perm_media</i></span>
          <span style='float:right' onclick='(toggle("edt"),cm_refresh())'><i class='material-icons'>edit_square</i></span>
        </div>
        <div id='edt' class='row' style='display:none'>
          <input id='fopen' type='file' onchange='file_load(this.files)' style='display:none'/>
          <a id='fsave' style='display:none'></a>
          <div class='menu'>
            <i class='material-icons' onclick='forth("clear")'>home</i>
            <span></span>
            <i class='material-icons' onclick='file_new()'>create_new_folder</i>
            <i class='material-icons' onclick='$("#fopen").click()'>folder</i>
            <i class='material-icons' onclick='file_save()'>drive_file_move_rtl</i>
            <span></span>
            <i class='material-icons' onclick='(forth("clear"),forth("boot"))'>do_not_step</i>
            <i onclick='forth(cm.getSelection())' class='material-icons'>install_desktop</i>
            <i onclick='forth(cm.getValue())' class='material-icons'>directions_run</i>
          </div>
          <textarea id='cm'>\ highlight the code and hit <Ctrl-Enter> to run</textarea>
        </div>
        <div id='txt' class='txt'></div>
        <div><input id='tib' class='code' value='' /></div>
        <div id='ss' class='ss'>[ ]</div>
      </div>
      <div id='gra' class='col' style='display:none; width:100%'>
        <canvas id='can'></div>
      </div>
    </div>
    <script src='../eforth.js'></script>
    <script>
    const $ = (s)=>s[0]=='#' && !s.includes(' ') ?      /* ala jQuery */
        document.querySelector(s) : document.querySelectorAll(s)
    const dir = $('#dir'), usr = $('#usr'), dc = $('#dc')
    const tib = $('#tib'), txt = $('#txt'), ss = $('#ss')
    const run = (doc)=>forth(doc.getSelection())
    const cm  = CodeMirror.fromTextArea($('#cm'), {
        lineNumbers: true, styleActiveLine: true,
        mode: 'forth',                            /// * Forth language
        extraKeys: { 'Ctrl-Enter': (e)=>forth(e.getSelection()) }
    })
    const rz  = new ResizeObserver(e=>{           ///< adjust console height
        edt.style.height = cm.innerHeight
        txt.scrollTop    = txt.scrollHeight
    }).observe($('#cm'))
      
    tib.onkeydown = (e)=>{                        ///< console input
        if (13!=e.keyCode) return
        forth(tib.value)
        tib.value = ''
        txt.scrollTop = txt.scrollHeight          /// * scroll down
        tib.focus()
    }
    function toggle(id) {
        let sty = $('#'+id).style
        sty.display = sty.display=='none' ? 'flex' : 'none'
    }
    function cm_refresh() {                       /// * fix line number issue
        $('#edt > .CodeMirror').forEach(e=>e.CodeMirror.refresh())
    }
    function file_new() {
        let fn = prompt('Create new file', 'untitled.f')
        if (fn) $('#fname').innerHTML = fn
    }
    function file_load(flst) {
        if (flst.length != 1) return
        let fn = flst[0]
        $('#fname').innerHTML = fn.name
        let rdr = new FileReader()
        rdr.onload = (e)=>cm.setValue(e.target.result)
        rdr.readAsText(fn);
    }
      function file_save() {
        let blob = new Blob([ cm.getValue() ], { type: 'text/plain' })
        let lnk  = $('#fsave')
        let fn   = prompt('Save to file name', $('#fname').innerHTML)
        if (!fn) return
        lnk.download = fn
        lnk.href = window.webkitURL ?
            window.webkitURL.createObjectURL(blob) :
            window.URL.createObjectURL(blob)
        lnk.click()
      }
          
    function to_txt(t, esc=true) {
        const escape = (s)=>{
            return s.replace(/\n/g,'<br/>').replace(/\s/g, '&nbsp;')
        }
        txt.innerHTML += esc && typeof(t)=='string' ? escape(t) : t
    }
    function clear_txt() { txt.innerHTML='' }
    function show_cmd(cmd) {
        let htm = cmd.replace(/:/g,'<br/>:')                  /// * show on a new line
        if (htm.indexOf('<br/>')==0) htm.replace('<br/>','')  /// * remove blank lines
        to_txt(`<pre class="cmd"><em>${htm}</em></pre>`, false)
    }
    ///
    /// Forth section
    ///
    let vm = new ForthVM(to_txt)               ///< create Forth VM object
    clear_txt()                                /// * init console area
    show_voc(dc)                               /// * Forth word tree in sidebar

    function forth(cmd) {                      ///< evaludate Forth command
        show_cmd(cmd)
        if (cmd=='clear') clear_txt()
        else {
            vm.exec(cmd)                       /// * can handle multi-line input
            ss.innerHTML = '[ '+vm.ss.map(v=>v.toString(vm.base)).join(' ')+' ]'
            usr.innerHTML = colon_words()
        }
    }
    </script>
    <script type='application/forth'>
      cr .( <h3>\ this demo shows embedded Forth</h3> ) cr
      .( <b>\ list dictionary</b> ) cr
      words
    </script>
    <!--script type='application/forth' src='./tests/embed.f'/-->
  </body>
</html>
